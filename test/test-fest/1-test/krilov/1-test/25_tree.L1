; Tree test - allocates a tree, then traverses it and prints it.
((
  ; Create a tree structure containing the following values:
  ;
  ;      (7777)
  ;        |
  ;        1
  ;       / \
  ;     2    5
  ;    /\    /\
  ;   3  4  6  7
  ;  /\ /\ /\  /\
  ; . .. .. . .  .  (all dots here indicate 9999)
  ;
  ; Each node in the tree is a list containing a value, the address of the left child,
  ; the address of the right child, and the address of the parent.
  ; The node containing 9999 is a sentinel - we ignore and continue traversal if we encounter it in the address of the child.
  ; The node containing 7777 is also a sentinel - if we encounter it in the address of the parent, then we know we're 
  ; at the root node.
  
  ; Allocate the root (containing the value 1) - rsi will contain the pointer to the root of the tree
  (rax <- (allocate 9 3))
  (rsi <- rax)
  (rdi <- rax)
  
  ; Allocate the 7777 sentinel and set the root's parent pointer to it.
  (rax <- (allocate 9 7777))
  ((mem rsi 16) <- rax)
  
  ; Allocate the left subtree
  ; -------------------------
  
  ; 2
  (rax <- (allocate 9 5))
  ((mem rax 16) <- rdi)  ; Set the parent pointer
  ((mem rdi 8) <- rax)   ; Update parent's left child
  (rdi <- rax)
  
  ; 3
  (rax <- (allocate 9 7))
  ((mem rax 16) <- rdi)  ; Set the parent pointer
  ((mem rdi 8) <- rax)   ; Update parent's left child
  (rdi <- rax)
  
  ; 9999 sentinel
  (rax <- (allocate 9 9999))
  ((mem rax 16) <- rdi)  ; Set the parent pointer
  ((mem rdi 8) <- rax)   ; Update parent's left child
  ((mem rdi 12) <- rax)  ; Also update parent's right child
  
  ; Set rdi to point to the 2 node
  (rdi <- (mem rdi 16))
  
  ; 4
  (rax <- (allocate 9 9))
  ((mem rax 16) <- rdi)  ; Set the parent pointer
  ((mem rdi 12) <- rax)   ; Update parent's right child
  (rdi <- rax)
  
  ; Allocate another 9999 sentinel
  (rax <- (allocate 9 9999))
  ((mem rax 16) <- rdi)  ; Set the parent pointer
  ((mem rdi 8) <- rax)   ; Update parent's left child
  ((mem rdi 12) <- rax)  ; Also update parent's right child
  
  ; Set 4's children to the sentinel node
  ((mem rdi 8) <- rax)
  ((mem rdi 12) <- rax)
  
  ;; Allocate the right subtree
  ;; --------------------------
  
  ; Set rdi to point to the root again
  (rdi <- rsi)
  
  ; 5
  (rax <- (allocate 9 11))
  ((mem rax 16) <- rdi)  ; Set the parent pointer
  ((mem rdi 12) <- rax)   ; Update parent's right child
  (rdi <- rax)
  
  ; 6
  (rax <- (allocate 9 13))
  ((mem rax 16) <- rdi)  ; Set the parent pointer
  ((mem rdi 8) <- rax)   ; Update parent's left child
  (rdi <- rax)
  
  ; 9999 sentinel
  (rax <- (allocate 9 9999))
  ((mem rax 16) <- rdi)  ; Set the parent pointer
  ((mem rdi 8) <- rax)   ; Update parent's left child
  ((mem rdi 12) <- rax)  ; Also update parent's right child
  
  ; Set rdi to point to the 5 node
  (rdi <- (mem rdi 16))
  
  ; 7
  (rax <- (allocate 9 15))
  ((mem rax 16) <- rdi)  ; Set the parent pointer
  ((mem rdi 12) <- rax)   ; Update parent's right child
  (rdi <- rax)
  
  ; Allocate another 9999 sentinel
  (rax <- (allocate 9 9999))
  ((mem rax 16) <- rdi)  ; Set the parent pointer
  ((mem rdi 8) <- rax)   ; Update parent's left child
  ((mem rdi 12) <- rax)  ; Also update parent's right child
  
  ; Set 7's children to the sentinel node
  ((mem rdi 8) <- rax)
  ((mem rdi 12) <- rax)
  
  ; Now traverse the tree structure (preorder), whose root is at rsi
  (rdi <- rsi)
  (call :traverse_tree)
  )
  (:traverse_tree
    ; rdi points to the current node
	
	; Get the value of the current node and print it
	(rax <- (mem rdi 4))
	(rax <- (print rax))
	
	; Get the pointer to the left child and check its value - if it's 9999, it's the sentinel, so skip it.
	(rsi <- rdi)
	(rdi <- (mem rdi 8))
	(rax <- (mem rdi 4))
	(cjump rax = 9999 :skip_left_child :visit_left_child)
	
	:visit_left_child
	(call :traverse_tree)
	
	:skip_left_child
	(rdi <- rsi)
	
	; Get the pointer to the right child and check its value - if it's 9999, it's the sentinel, so skip it.
	(rdi <- (mem rdi 12))
	(rax <- (mem rdi 4))
	(cjump rax = 9999 :skip_right_child :visit_right_child)
	
	:visit_right_child
	(call :traverse_tree)
	
	:skip_right_child
	(rdi <- rsi)
	
	; Set rsi to the parent
	(rsi <- (mem rdi 16))
	
	:done
	(return)
  )
)
